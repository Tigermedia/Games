{
  "name": "Gmail Agent - Auto Label v2",
  "nodes": [
    {
      "parameters": {
        "pollTimes": {
          "item": [{ "mode": "everyMinute" }]
        },
        "filters": { "readStatus": "unread" },
        "simple": false,
        "options": { "maxResults": 10 }
      },
      "name": "Gmail Trigger",
      "type": "n8n-nodes-base.gmailTrigger",
      "typeVersion": 1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "jsCode": "// Label ID mapping (from Gmail API)\nconst LABEL_MAP = {\n  'ðŸ’¼ Work': 'Label_144',\n  'ðŸ’¼ Work/Clients': 'Label_145',\n  'ðŸ’¼ Work/Team': 'Label_146',\n  'ðŸ’¼ Work/Projects': 'Label_147',\n  'ðŸ’¼ Work/Invoices': 'Label_148',\n  'ðŸ‘¤ Personal': 'Label_149',\n  'ðŸ‘¤ Personal/Family': 'Label_150',\n  'ðŸ‘¤ Personal/Friends': 'Label_151',\n  'ðŸ‘¤ Personal/Health': 'Label_152',\n  'ðŸ“° Newsletters': 'Label_153',\n  'ðŸ“° Newsletters/Tech': 'Label_154',\n  'ðŸ“° Newsletters/Business': 'Label_155',\n  'ðŸ“° Newsletters/Other': 'Label_156',\n  'ðŸ”” Notifications': 'Label_157',\n  'ðŸ”” Notifications/Social': 'Label_158',\n  'ðŸ”” Notifications/Security': 'Label_159',\n  'ðŸ”” Notifications/Apps': 'Label_160',\n  'ðŸ”” Notifications/Banking': 'Label_161',\n  'ðŸ›’ Shopping': 'Label_162',\n  'ðŸ›’ Shopping/Orders': 'Label_163',\n  'ðŸ›’ Shopping/Shipping': 'Label_164',\n  'ðŸ›’ Shopping/Returns': 'Label_165',\n  'ðŸ’° Finance': 'Label_166',\n  'ðŸ’° Finance/Invoices': 'Label_167',\n  'ðŸ’° Finance/Receipts': 'Label_168',\n  'ðŸ’° Finance/Banking': 'Label_169',\n  'ðŸ’° Finance/Payments': 'Label_170',\n  'ðŸ“… Calendar': 'Label_171',\n  'ðŸ“… Calendar/Meetings': 'Label_172',\n  'ðŸ“… Calendar/Events': 'Label_173',\n  'â¬‡ï¸ Low Priority': 'Label_174',\n  'â¬‡ï¸ Low Priority/Promotions': 'Label_175',\n  'â¬‡ï¸ Low Priority/Bulk': 'Label_176',\n  'âœ… Processed': 'Label_142',\n  'ðŸ“¥ To Review': 'Label_143'\n};\n\nconst email = $input.item.json;\nconst getHeader = (name) => {\n  const header = email.payload?.headers?.find(h => h.name.toLowerCase() === name.toLowerCase());\n  return header?.value || '';\n};\n\nreturn {\n  json: {\n    id: email.id,\n    threadId: email.threadId,\n    from: getHeader('From'),\n    subject: getHeader('Subject'),\n    snippet: email.snippet || '',\n    date: getHeader('Date'),\n    labelMap: LABEL_MAP\n  }\n};"
      },
      "name": "Extract Email Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [450, 300]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "You are an email classifier. Analyze this email and classify it.\n\nMAIN CATEGORIES (choose the most specific match):\n- ðŸ’¼ Work (general work), ðŸ’¼ Work/Clients, ðŸ’¼ Work/Team, ðŸ’¼ Work/Projects, ðŸ’¼ Work/Invoices\n- ðŸ‘¤ Personal (general personal), ðŸ‘¤ Personal/Family, ðŸ‘¤ Personal/Friends, ðŸ‘¤ Personal/Health\n- ðŸ“° Newsletters (general), ðŸ“° Newsletters/Tech, ðŸ“° Newsletters/Business, ðŸ“° Newsletters/Other\n- ðŸ”” Notifications (general), ðŸ”” Notifications/Social, ðŸ”” Notifications/Security, ðŸ”” Notifications/Apps, ðŸ”” Notifications/Banking\n- ðŸ›’ Shopping (general), ðŸ›’ Shopping/Orders, ðŸ›’ Shopping/Shipping, ðŸ›’ Shopping/Returns\n- ðŸ’° Finance (general), ðŸ’° Finance/Invoices, ðŸ’° Finance/Receipts, ðŸ’° Finance/Banking, ðŸ’° Finance/Payments\n- ðŸ“… Calendar (general), ðŸ“… Calendar/Meetings, ðŸ“… Calendar/Events\n- â¬‡ï¸ Low Priority (general), â¬‡ï¸ Low Priority/Promotions, â¬‡ï¸ Low Priority/Bulk\n\nEmail:\nFrom: {{ $json.from }}\nSubject: {{ $json.subject }}\nPreview: {{ $json.snippet }}\n\nRespond with ONLY valid JSON (no markdown):\n{\"label\": \"exact label with emoji\", \"sublabel\": \"specific sublabel if applicable or null\", \"confidence\": 85, \"reason\": \"brief reason\"}",
        "options": {
          "systemMessage": "You are an email classifier. Always respond with valid JSON only. No markdown code blocks."
        }
      },
      "name": "AI Classify",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [650, 300]
    },
    {
      "parameters": {
        "jsCode": "const email = $('Extract Email Data').item.json;\nconst labelMap = email.labelMap;\nconst ai = $input.item.json;\n\nlet result;\ntry {\n  let output = ai.output || ai.text || JSON.stringify(ai);\n  // Clean markdown code blocks if present\n  output = output.replace(/```json\\n?/g, '').replace(/```\\n?/g, '').trim();\n  result = typeof output === 'string' ? JSON.parse(output) : output;\n} catch (e) {\n  result = { label: 'ðŸ“¥ To Review', confidence: 0, reason: 'Parse error' };\n}\n\n// Get the most specific label (sublabel if exists, otherwise main label)\nconst finalLabel = result.sublabel || result.label || 'ðŸ“¥ To Review';\nconst labelId = labelMap[finalLabel] || labelMap['ðŸ“¥ To Review'];\nconst processedId = labelMap['âœ… Processed'];\nconst toReviewId = labelMap['ðŸ“¥ To Review'];\n\nreturn {\n  json: {\n    emailId: email.id,\n    from: email.from,\n    subject: email.subject,\n    label: finalLabel,\n    labelId: labelId,\n    processedId: processedId,\n    toReviewId: toReviewId,\n    confidence: result.confidence || 0,\n    reason: result.reason || '',\n    isHighConfidence: (result.confidence || 0) >= 80\n  }\n};"
      },
      "name": "Parse Result",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [850, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": { "caseSensitive": true, "typeValidation": "strict" },
          "combinator": "and",
          "conditions": [{
            "leftValue": "={{ $json.isHighConfidence }}",
            "rightValue": true,
            "operator": { "type": "boolean", "operation": "equals" }
          }]
        }
      },
      "name": "High Confidence?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [1050, 300]
    },
    {
      "parameters": {
        "operation": "addLabels",
        "messageId": "={{ $json.emailId }}",
        "labelIds": ["={{ $json.labelId }}", "={{ $json.processedId }}"]
      },
      "name": "Apply Label + Processed",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [1250, 200]
    },
    {
      "parameters": {
        "operation": "addLabels",
        "messageId": "={{ $json.emailId }}",
        "labelIds": ["={{ $json.toReviewId }}"]
      },
      "name": "Mark for Review",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [1250, 400]
    }
  ],
  "connections": {
    "Gmail Trigger": {
      "main": [[{"node": "Extract Email Data", "type": "main", "index": 0}]]
    },
    "Extract Email Data": {
      "main": [[{"node": "AI Classify", "type": "main", "index": 0}]]
    },
    "AI Classify": {
      "main": [[{"node": "Parse Result", "type": "main", "index": 0}]]
    },
    "Parse Result": {
      "main": [[{"node": "High Confidence?", "type": "main", "index": 0}]]
    },
    "High Confidence?": {
      "main": [
        [{"node": "Apply Label + Processed", "type": "main", "index": 0}],
        [{"node": "Mark for Review", "type": "main", "index": 0}]
      ]
    }
  },
  "settings": { "executionOrder": "v1" }
}
